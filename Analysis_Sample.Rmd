---
title: "Analysis_sample"
author: "Yeuk Yu Lee"
date: ""
output: 
  html_document:
    toc:  true
    toc_float:  true
    code_folding:  show
---
```{r, include = F, echo = F, warning = F, mwssage = F}
# Import Libraries
library(data.table)
library(ggplot2)
library(reshape2)
library(dplyr)
library(gridExtra)
library(scales)
library(MASS)
library(broom)
cus_theme <- theme(
    plot.title = element_text(size = 18, color = "#816852", family = "Copperplate Light", margin = margin(0, 0, 10, 0)),
    text = element_text(size = 14, color = "#8A594C", family = "Copperplate Light" ),
    legend.key = element_rect(fill = "white"),
    legend.background = element_rect(fill = "white"),
    panel.grid.major = element_line(colour = "white"),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = rel(0.7), color = "rosybrown4", family = "Roboto"),
    axis.text.y = element_text(size = rel(0.7), color = "rosybrown4", family = "Roboto"),
    axis.title = element_text(size = 10, family = "Julius Sans One"),
    axis.title.y = element_text(margin = margin(0, 10, 0, 0)),
    axis.title.x = element_text(margin = margin(10, 0, 0, 0))
)

bike_data = read.table("exam1-59.txt")
```

# I. Introduction

Bike sharing system is believed to be useful in identifying changes in mobility in city. Some early findings have shown that weather factors, such as temperature and humidity, seemed to determine how likely a user would rent bikes, but the affect of wind speed is less obvious, given that a strong wind can either be a hindrance or help in bike rides. This report aims to uncover how wind could be influential in number of bike rental: in particular, this report will explore the hypothesis that a lower wind speed corresponds to more bike users in a given hour.

# II. Explanatory Data Analysis (EDA)
The bike usage data used in this study is a set of hourly data drawn from Washington D.C./ Arlington, VA/MD area. In this dataset, there are in total 164 hourly records, collected over seven randomly chosen days from the same month in 2011 or 2012. The variables included in the dataset are wind speed, which is wind speed in km/hour, and count, which is the total number of rental bikes being used that hour. 

As seen in figure 2, the distribution of both bike counts and wind speed are unimodal and right skewed. The observed wind speed ranges from 0.0 to about 0.55 km/hr, with a peak at about 0.1 km/hr. The median of wind speed is about 0.16 and mean is 0.19 km/hr. On the other hand, the distribution of bike rental counts ranges from 0 to about 460 users per hour, with a mode at about 20 rentals. The median of bike rental is about 79 and a mean of 106.2 rentals per day. Additional statistic summary can be found in table 1. 

```{r, include = F, echo = F, warning = F, mwssage = F}
# Generate Summary
summary(bike_data)
dim(bike_data)

# Histogram for both variables
speed_hist <- (ggplot(data = bike_data) + geom_histogram(aes(x = Windspeed), fill = "rosybrown3", binwidth = 0.03)
                           + ggtitle("Distribution of Windspeed")
                           + labs(x = "Windspeed(km/hr)", y = "Count of Hours")
                           + cus_theme)

count_hist <- (ggplot(data = bike_data) + geom_histogram(aes(x = Count), fill = "rosybrown3")
                           + ggtitle("Distribution of Bike Rentals")
                           + labs(x = "Bike Rentals", y = "Count of Hours")
                           + cus_theme)

grid.arrange(speed_hist, count_hist, nrow = 1)

```

# III. Diagnosis
Before applying a linear regression modal on wind speed and count, we carry out a diagnosis to examine the normality of wind speed and the normal assumption of error term. From the scatterplot of initial data (figure 3), count and wind speed does not seemed to have a strong correlation. The initial fitted regression line of lm(count ~ windspeed) suggests a weak positive relationship between wind speed and count with correlation of 0.460. The least square estimates are ($\beta_0$??_0,??_1)=(85.89,106.01). 
```{r, include = F, echo = F, warning = F, mwssage = F}
# Scatterplot
(ggplot(data = bike_data, aes(x = Windspeed, y = Count)) + geom_point(color = "indianred3")
                           + ggtitle("Distribution of Bike Rental Count \nby Windspeed")
                           + labs(x = "Windspeed(km/hr)", y = "Bike Rental Count")
                           + geom_smooth(method = lm, se = FALSE, color = "peachpuff4")
                           + cus_theme)

# Compute regression line
reg.line <- lm(bike_data$Count ~ bike_data$Windspeed)
est.coef <- reg.line$coef
summary(reg.line)

# Diagnosis
speed.res = resid(reg.line)

# Residual Plot
res_plot <- (ggplot(data = bike_data, aes(x = Windspeed, y = speed.res)) + geom_point(color = "lightskyblue4")
                           + ggtitle("Windspeed(km/hr) vs. \nResiduals")
                           + labs(x = "Windspeed(km/hr)", y = "Residual")
                           + geom_hline(yintercept = 0)
                           + cus_theme)


# QQ Plot
slope = (quantile(speed.res ,p=.75)-quantile(speed.res,.25))/(qnorm(.75)-qnorm(.25)) 
intercept = quantile(speed.res,.25) - slope*qnorm(.25) 
qq_line = data.frame(intercept=intercept,slope=slope) 
qq_plot <- (ggplot(data = bike_data) + stat_qq(aes(sample = speed.res), color = "lightskyblue4")
                           + ggtitle("QQPlot of \nWindspeed")
                           + labs(x = "Theoractical Quantile", y = "Standardized Residual")
                           + geom_abline(data = qq_line ,aes(intercept = intercept ,slope=slope) )
                           + cus_theme)

residual_plot <- (ggplot(data = bike_data, aes(x = c(1:167), y = speed.res)) + geom_point(color = "lightskyblue4")
                           + ggtitle("Residuals Plot of \nCount")
                           + labs(x = "Residual Interval", y = "Residual")
                           + geom_hline(yintercept = 0)
                           + cus_theme)

df <- augment(reg.line)

residual_plot
plot(speed.res ,pch = 16, xlab = "Residual Index", ylab = "Residuals", main = "Residual Plots of Call Duration")
# Boxcox
box_cox_plot <- boxcox(bike_data$Count ~ bike_data$Windspeed)   # Boxcox suggeted 0.2
title("Boxcox Before Transformation")

## Before Diagnosis
grid.arrange(res_plot, qq_plot, residual_plot, nrow = 1)

```

From the residual plot in figure 4 of wind speed, it appears that the residuals scatters fairly randomly around y = 0 line, though there seemed to have more data points below y = 0 line, when windspeed is in between 0.1 and 0.25 km/hr. The variance of the residual larger on above y = 0 and smaller below, with mild convergence towards 0 when wind speed is beyond 0.4 km/hr, and therefore constant variance assumption is violated. The residual plot also displays a slight worrying pattern. Residuals vs. residual index seemed to follow a sine wave pattern, traveling beyond and below y = 0 line, indicating that error terms might not be independent. As observed from the QQplot, the distribution of wind speed violates normal assumption: it is asymmetric, truncated on the left and tailing to the right. The boxcox on initial data suggested that a transformation of ??=0.2. 

```{r, include = F, echo = F, warning = F, mwssage = F}
# Data Transformation
bike_data$Count <- (bike_data$Count)^0.2               # transform Y
#bike_data$Windspeed <- (bike_data$Windspeed)  # transform X
reg.line_after <- lm(bike_data$Count~ bike_data$Windspeed)
est.coef <- reg.line_after$coef

# Diagnosis
speed.res = resid(reg.line_after)

# Residual Plot
res_plot <- (ggplot(data = bike_data, aes(x = Windspeed, y = speed.res)) + geom_point(color = "darkolivegreen4")
                           + ggtitle("Windspeed(km/hr) \nvs. Residuals")
                           + labs(x = "Windspeed(km/hr)", y = "Residual")
                           + geom_hline(yintercept = 0)
                           + cus_theme)


# QQ Plot
slope = (quantile(speed.res ,p=.75)-quantile(speed.res,.25))/(qnorm(.75)-qnorm(.25)) 
intercept = quantile(speed.res,.25) - slope*qnorm(.25) 
qq_line = data.frame(intercept=intercept,slope=slope) 

qq_plot <- (ggplot(data = bike_data) + stat_qq(aes(sample = speed.res), color = "darkolivegreen4")
                           + ggtitle("QQPlot of \nWindspeed")
                           + geom_abline(data = qq_line ,aes(intercept = intercept ,slope=slope) )
                           + labs(x = "Theoractical Quantile", y = "Standardized Residual")
                           + cus_theme)

residual_plot <- (ggplot(data = bike_data, aes(x = c(1:167), y = speed.res)) + geom_point(color = "darkolivegreen4")
                           + ggtitle("Residuals Plot of \n(Count)^0.2")
                           + labs(x = "Residual Interval", y = "Residual")
                           + geom_hline(yintercept = 0)
                           + cus_theme)

# Boxcox
box_cox_plot <- boxcox(bike_data$Count ~ bike_data$Windspeed)
title("Boxcox After Transformation")

#residual plot
residual_plot

## After Diagnosis
grid.arrange(res_plot, qq_plot, residual_plot, nrow = 1)

```

To remedy the constant error variance assumption between wind speed and count, a transformation of (count)^0.2 is applied to count, as suggested by boxcox transformation. After rerunning the diagnosis on transformed data, the distribution of wind speed appears to be fairly normal, as indicated in the QQplot. Even though the observations of wind speed tails mildly upward at both ends, normality is approximately justified. Boxcox also suggests that no further transformation on count is necessary, since 1 falls well within the range of suggested transformation. Regarding the independence of error, the wave pattern that was observed previously in residual plot now appears to be more random scattered, indicating independence in error term is justified. Even though some residual still seemed to align in a vague vertical line pattern, we proceed to apply linear regression to the transformed data.

# IV. Model Inference and Results
As from R output, the final model on the transformed data yields ((??_0 ) ??,(??_1 ) ??)=(2.121 ,1.267). In other words, when wind speed is 0 km/hr, the transformed bike rental count is expected to be approximately 2.121 per hour. For each km/hr increase in wind speed, the bike rental count per hour is expected to rise approximately 1.267. The reported 95% CI for (??_0 ) ?? is (1.973, 2.270) and  (??_1 ) ?? is (0.529, 2.004). In other words, we are 95% confident that the true value of transformed bike rental number given windspeed is 0 km/hr in transformed data lies in the interval (1.973, 2.270) and the true rise in transformed bike rental number given 1 km/hr increase in windspeed lies in (0.529, 2.004). 

Since the confidence interval for ??_1 does not contain 0, windspeed is a significant predictor in predicting count. To further endorse that, the p-value for t-test on ??_1 against the null hypothesis that ??_1=0 is about 0.0008, which is smaller than any reasonable confidence level. Since ??_1  is unlikely to be 0, which means that for each 1 km/hr increase in windspeed, the corresponding increase in bike rental is not zero. We therefore conclude that there is a linear relationship between transformed wind speed and count.

# V. Conclusion/ Discussion
After applying the linear regression model to the dataset, we conclude that there is a significant linear relationship between the wind speed and count in the transformed bike usage dataset. Therefore, wind speed can be a factor in determining bike usage in a given hour. However, this model fails to meet the error independence assumption in the earlier diagnosis. It is reasonable to suspect that wind speed at a given hour is related to the wind speed in the previous hour. To increase the accuracy of this model, one suggestion will be to draw data points from random hour of randomly chosen days, instead of sampling consecutive 24 hours in seven randomly day, which would potential creates problem in independence of error.
